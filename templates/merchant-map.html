<!DOCTYPE html>
<html>
<head>
    <title>Merchant Map</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/merchant-map.css') }}">
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDzGxjSG77K2SBQi2sWtVRYimFLpHlKYmg&callback=initMap&libraries=marker&v=beta&solution_channel=GMP_CCS_infowindows_v2" defer></script>
    <script>
        // Store coordinates in global variables
        const CUSTOMER_LAT = {{ customer_lat|float }};
        const CUSTOMER_LNG = {{ customer_long|float }};
        const CUSTOMER_ADDRESS = "{{ session.address_combined }}";
    </script>
    <script src="{{ url_for('static', filename='map.js') }}"></script>
</head>
<body>
    <nav class="navbar">
        <div class="logo">Ripple Banking</div>
        <input type="text" class="search-bar" placeholder="Search merchants...">
    </nav>

    <div id="merchant-data" style="display:none;">{{ merchants|tojson|safe }}</div>

    <script>
        const customerLat = {{ customer_lat }};
        const customerLong = {{ customer_long }};
        const merchantList = {{ merchants|tojson|safe }};
    </script>
    <div class="main-container">
        <div class="map-container">
            <div class="map-placeholder"></div>
        </div>

        <div class="merchants-list">
            <div class="filters">
                <button class="filter-btn">Recommended</button>
                <button class="filter-btn">Closest</button>
                <button class="filter-btn">Highest Rated</button>
            </div>

            {% for merchant in merchants %}
            <div class="merchant-card" 
                 data-lat="{{ merchant.latitude }}" 
                 data-lng="{{ merchant.longitude }}"
                 data-name="{{ merchant.name }}">
                <div class="merchant-image">
                    <img src="{{ url_for('static', filename=merchant['image_path']) }}">
                </div>
                <h3 class="merchant-name">{{ merchant.name }}</h3>
                <div class="merchant-rating">
                    {{ merchant.stars }} 
                    <span>{{ merchant.rating }} ({{ merchant.reviews }} reviews)</span>
                </div>
                <div class="merchant-details">
                    {{ merchant.address }}<br>
                    {{ merchant.distance }} miles away<br>
                    {{ merchant.business_hours or 'Hours not available' }}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <script>
        document.querySelector('.search-bar').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            document.querySelectorAll('.merchant-card').forEach(card => {
                const cardText = card.textContent.toLowerCase();
                card.style.display = cardText.includes(searchTerm) ? 'block' : 'none';
            });
        });

        document.querySelectorAll('.merchant-card').forEach(card => {
            card.addEventListener('click', function() {
                const lat = parseFloat(this.getAttribute('data-lat'));
                const lng = parseFloat(this.getAttribute('data-lng'));
                
                if (!isNaN(lat) && !isNaN(lng)) {
                    const position = { lat, lng };
                    map.setCenter(position);
                    map.setZoom(16);
                }
            });
        });
    </script>
</body>
</html>